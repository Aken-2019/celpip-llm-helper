{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load api2d_filters %}
{% load static %}

{% block content %}
    <h2>账户积分</h2>
    <div class="card shadow mt-4">
        <div class="card-body">
            {% if has_api_key %}
                <div class="mt-3">
                    <div id="creditsSection" class="alert alert-info">
                        <i class="bi bi-currency-dollar me-2"></i>
                        <span id="creditsAmount">Checking credits...</span>
                    </div>
                    <div class="mt-3">
                        <a href="https://api2d.com/merchant/{{ api_key.group.type_id }}?hide_key_input=1&hide_key=1&key={{ api_key.key|base64encode }}" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-credit-card me-1"></i> 积分充值
                        </a>
                    </div>
                </div>
            {% else %}
                <h5 class="card-title">Add New API Key</h5>
                <form method="post" action="{% url 'api2d:api-key' %}">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <div class="form-text mb-3">
                        Enter your API key to link it to your account.
                    </div>
                    <button type="submit" class="btn btn-primary">Save API Key</button>
                </form>
            {% endif %}
        </div>
    </div>

    {% if user.is_superuser %}
    <div class="card shadow mt-4">
        <div class="card-body">
            <h5 class="card-title">点卡信息</h5>
            <div class="input-group mb-3">
                <input type="text" 
                    class="form-control" 
                    value="{{ api_key.key }}" 
                    id="apiKey" 
                    readonly>
                <button class="btn btn-outline-secondary" 
                        type="button" 
                        onclick="copyToClipboard()">
                    Copy
                </button>
            </div>
            <p class="text-muted">
                <small>
                    创建日期: {{ api_key.created_at|date:"M d, Y H:i" }}<br>
                    {% if api_key.expired_at %}
                        到期日期: {{ api_key.expired_at|date:"M d, Y H:i" }}
                    {% endif %}
                </small>
            </p>
            <a href="{% url 'api2d:api-key-delete' %}" class="btn btn-outline-danger">
                <i class="bi bi-trash me-1"></i> 删除 API Key
            </a>
        </div>
    </div>
    {% endif %}

{% block extra_js %}
<script src="{% static 'api2d/js/apiClient.js' %}"></script>
{% endblock %}
<script>
    // Initialize the API client
    const apiClient = new ApiClient({
        baseUrl: '{{ api2d_openai_endpoint }}'
    });

    // Function to fetch and display credits
    // Call fetchCredits when the page loads if we have an API key
    document.addEventListener('DOMContentLoaded', () => {
        const apiKeyInput = document.getElementById('apiKey');
        if (apiKeyInput && apiKeyInput.value) {
            apiClient.fetchCredits(apiKeyInput.value)
                .then(response => {
                    const creditsSection = document.getElementById('creditsSection');
                    const creditsAmount = document.getElementById('creditsAmount');
                    creditsSection.style.display = 'block';
                    creditsAmount.textContent = `可用积分: ${response.total_available}`;
                })
                .catch(error => {
                    console.error('Error fetching credits:', error);
                    // Show an error message to the user
                    creditsSection.className = 'alert alert-danger';
                    creditsAmount.textContent = 'Failed to fetch credits. Please try again later.';
                });
        }
    });

    function copyToClipboard() {
        const copyText = document.getElementById("apiKey");
        copyText.select();
        copyText.setSelectionRange(0, 99999); // For mobile devices
        document.execCommand("copy");
        
        // Optional: Show a tooltip or change the button text
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = "Copied!";
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    }
</script>
{% endblock %}